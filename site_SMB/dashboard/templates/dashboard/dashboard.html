<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% load static %}  <!--load static medias-->
    <title>data Dashboard</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
    <!--  rete -->
    <script src={% static './dashboard/node_modules/vue/dist/vue.js' %}></script>
    <script src={% static './dashboard/node_modules/rete/build/rete.min.js' %}></script>
    <script src={% static './dashboard/node_modules/rete-vue-render-plugin/build/vue-render-plugin.min.js' %}></script>
    <script src={% static './dashboard/node_modules/rete-connection-plugin/build/connection-plugin.min.js' %}></script>
    <script src="https://cdn.jsdelivr.net/npm/rete-context-menu-plugin/build/context-menu-plugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rete-area-plugin/build/area-plugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rete-comment-plugin/build/comment-plugin.min.js"></script>
    <script src={% static './dashboard/node_modules/rete-history-plugin/build/history-plugin.min.js' %}></script>
    <script src="https://cdn.jsdelivr.net/npm/rete-connection-mastery-plugin/build/connection-mastery-plugin.min.js"></script>


    <!-- ---   -->
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>


<body onload="Toolbar.switchToolbar('favorites');">
<div class="gridWrapper">
    <div class="box-menu  boxShadow">   <!-- block for file upload -->
        <!-- Upload form. make sure use enctype attribute! -->
        <button class="menuButton" name="favorites" onclick="Toolbar.switchToolbar('favorites')">Favorites</button>
        <button class="menuButton" name="math" onclick="Toolbar.switchToolbar('math')">Math</button>
    </div>

    <div class="box-action">
        <input class="actionButton" type="image" src="{% static 'dashboard/run.svg' %}" onclick="run()"></input>
    </div>
    <div class="box-account">
        <input id="buttonToShowAccountPopup" class="actionButton" type="image" src="{% static 'dashboard/user.svg' %}" style="display: inline-block; width: 29px"
               onload="$sendGetAndCreatePopupBelow(this, 'accounts', newPopupId='accountPopup', align='right'); toggleAccountPopupOnEveryClick();" onclick="showAccountPopup()"/>
{#        <input class="actionButton" type="image" src="{% static 'dashboard/signup.png' %}" onload='this.style.display=#}
{#                ["inline-block", "none"][Number({{ loggedIn }})]' onclick="location.href = 'accounts/signup'"/>#}
{#        <input class="actionButton" type="image" src="{% static 'dashboard/login.png' %}" onload='this.style.display=#}
{#                ["inline-block", "none"][Number({{ loggedIn }})]' onclick="location.href = 'accounts/login'"/>#}
{#        <input class="actionButton" type="image" src="{% static 'dashboard/logout.png' %}" style="height: 44%;" onload='this.style.display=#}
{#                ["none","inline-block"][Number({{ loggedIn }})]' onclick="location.href = 'accounts/logout'"/>#}
    </div>

    <!-- set default onclick action to none, which will be changed after its dragged to a block-->
    <div id="toolbarFavorites" name="favorites" class="box-toolbar  boxShadow">   <!-- block for file upload -->
        <button id="inputToolButton" nodeType="input" configPanelName="inputConfigs" backendFunctionName="loadInputSheetAsDataframe"
                class="toolbarButton" draggable="true" ondragstart="Toolbar.drag(event)" onclick=
                        "return 0; BlockConfigPanel.setFileNameClickable($(this).attr('configPanelName'));BlockGraph.showToolConfig($(this).attr('configPanelName'), $(this).attr('blockNumber'));">
            <img src="{% static 'dashboard/input.svg' %}" style="width: 68px"><br>
            input
        </button>
        <button id="deleteARowOrColumnButton" configPanelName="deleteARowOrColumnConfigs"  backendFunctionName="deleteARowOrColumn"
                class="toolbarButton" draggable="true" ondragstart="Toolbar.drag(event)" onclick=
                        "return 0; BlockGraph.showToolConfig($(this).attr('configPanelName'), $(this).attr('blockNumber'));">
            <img src="{% static 'dashboard/deleteRow.svg' %}" style="width: 68px"><br>
            del row
        </button>
        <button id="sortToolButton" class="toolbarButton" configPanelName="sortConfigs" backendFunctionName="sortAColumn"
                draggable="true" ondragstart="Toolbar.drag(event)" onclick=
                        "return 0; BlockGraph.showToolConfig($(this).attr('configPanelName'), $(this).attr('blockNumber'));">
            <img src="{% static 'dashboard/sort.svg' %}" style="width: 68px"><br>
            sort
        </button>
        <button id="filterToolButton" class="toolbarButton" configPanelName="filterConfigs" backendFunctionName="filterAColumn"
                draggable="true" ondragstart="Toolbar.drag(event)" onclick=
                        "return 0; BlockGraph.showToolConfig($(this).attr('configPanelName'), $(this).attr('blockNumber'));">
            <img src="{% static 'dashboard/filter.svg' %}" style="width: 68px"><br>
            filter
        </button>
        <button id="outputToolButton" nodeType="endNode" class="toolbarButton" configPanelName="outputConfigs"
                backendFunctionName="downloadOutputFile" draggable="true" ondragstart="Toolbar.drag(event)" onclick=
                        "return 0; BlockGraph.showToolConfig($(this).attr('configPanelName'), $(this).attr('blockNumber'));">
            <img src="{% static 'dashboard/output.svg' %}" style="width: 68px"><br>
            output
        </button>
    </div>

    <div id="toolbarMath" name="math" class="box-toolbar">
    </div>

{#    configPanel ----------------------------------#}
    {% include 'configPanel/inputConfigs.html' %}
    {% include 'configPanel/deleteRowOrColumn.html' %}
    {% include 'configPanel/sortConfigs.html' %}
    {% include 'configPanel/filterConfigs.html' %}
    {% include 'configPanel/outputConfigs.html' %}
{#---------------------------------------------------#}

    <div class="box-graph boxShadow">
        <div id="blockGraphCanvas" >

        </div>
{#        <div id="graphBlock0" number="0" class="graphBlock" ondrop="BlockGraph.drop(event, this)" ondragover="BlockGraph.allowDrop(event)"></div>#}
    </div>

    <div class="box-result">
        <p>This is the result area</p>
    </div>
</div>

{% include "dashboard/scripts.html" %}
      <script>
        var numSocket = new Rete.Socket('Number value');
        var VueNumControl = {
          props: ['readonly', 'emitter', 'ikey', 'getData', 'putData'],
          template: '<input type="number" :readonly="readonly" :value="value" @input="change($event)" @dblclick.stop="" @pointerdown.stop="" @pointermove.stop=""/>',
          data() {
            return {
              value: 0,
            }
          },
          methods: {
            change(e){
              this.value = +e.target.value;
              this.update();
            },
            update() {
              if (this.ikey)
                this.putData(this.ikey, this.value)
              this.emitter.trigger('process');
            }
          },
          mounted() {
            this.value = this.getData(this.ikey);
          }
        }

        class NumControl extends Rete.Control {

          constructor(emitter, key, readonly) {
            super(key);
            this.component = VueNumControl;
            this.props = { emitter, ikey: key, readonly };
          }

          setValue(val) {
            this.vueContext.value = val;
          }
        }

        class NumComponent extends Rete.Component {

            constructor(){
                super("Number");
            }

            builder(node) {
                var out1 = new Rete.Output('num', "Number", numSocket);

                return node.addControl(new NumControl(this.editor, 'num')).addOutput(out1);
            }

            worker(node, inputs, outputs) {
                outputs['num'] = node.data.num;
            }
        }

        class AddComponent extends Rete.Component {
            constructor(){
                super("Add");
            }

            builder(node) {
                var inp1 = new Rete.Input('num',"Number", numSocket);
                var inp2 = new Rete.Input('num2', "Number2", numSocket);
                var out = new Rete.Output('num', "Number", numSocket);

                inp1.addControl(new NumControl(this.editor, 'num'))
                inp2.addControl(new NumControl(this.editor, 'num2'))

                return node
                    .addInput(inp1)
                    .addInput(inp2)
                    .addControl(new NumControl(this.editor, 'preview', true))
                    .addOutput(out);
            }

            worker(node, inputs, outputs) {
                var n1 = inputs['num'].length?inputs['num'][0]:node.data.num1;
                var n2 = inputs['num2'].length?inputs['num2'][0]:node.data.num2;
                var sum = n1 + n2;

                this.editor.nodes.find(n => n.id == node.id).controls.get('preview').setValue(sum);
                outputs['num'] = sum;
            }
        }

        (async () => {
            var container = document.querySelector('#blockGraphCanvas');
            var components = [new NumComponent(), new AddComponent()];

            var editor = new Rete.NodeEditor('demo@0.1.0', container);
            editor.use(ConnectionPlugin.default);
            editor.use(VueRenderPlugin.default);
            editor.use(ContextMenuPlugin.default);
            editor.use(AreaPlugin);
            editor.use(CommentPlugin.default);
            {#editor.use(HistoryPlugin);#}
            editor.use(ConnectionMasteryPlugin.default);

            var engine = new Rete.Engine('demo@0.1.0');

            components.map(c => {
                editor.register(c);
                engine.register(c);
            });

            var n1 = await components[0].createNode({num: 2});
            var n2 = await components[0].createNode({num: 0});
            var add = await components[1].createNode();

            n1.position = [80, 200];
            n2.position = [80, 400];
            add.position = [500, 240];


            editor.addNode(n1);
            editor.addNode(n2);
            editor.addNode(add);

            editor.connect(n1.outputs.get('num'), add.inputs.get('num'));
            editor.connect(n2.outputs.get('num'), add.inputs.get('num2'));


            editor.on('process nodecreated noderemoved connectioncreated connectionremoved', async () => {
              console.log('process');
                await engine.abort();
                await engine.process(editor.toJSON());
            });

            editor.view.resize();
            AreaPlugin.zoomAt(editor);
            editor.trigger('process');
        })();

        function allowDrop(event) {
          event.preventDefault();
        }
        </script>
</body>
</html>