{"version":3,"file":"history-plugin.esm.js","sources":["../src/history.js","../src/action.js","../src/actions/node.js","../src/actions/connection.js","../src/index.js"],"sourcesContent":["export default class History {\n    constructor() {\n        this.active = false;\n        this.produced = [];\n        this.reserved = [];\n    }\n\n    add(action) {\n        if (this.active) return;\n        this.produced.push(action);\n        this.reserved = [];\n    }\n\n    get last() {\n        return this.produced[this.produced.length - 1];\n    }\n\n    _do(from, to, type) {\n        const action = from.pop();\n\n        if (!action) return;\n\n        this.active = true;\n        action[type]();\n        to.push(action);\n        this.active = false;\n    }\n\n    undo() {\n        this._do(this.produced, this.reserved, 'undo');\n    }\n\n    redo() {\n        this._do(this.reserved, this.produced, 'redo');\n    }\n}","export default class Action {\n    undo() {}\n    redo() {}\n}","import Action from '../action';\n\nclass NodeAction extends Action {\n    constructor(editor, node) {\n        super();\n        this.editor = editor;\n        this.node = node;\n    }\n}\n\nexport class AddNodeAction extends NodeAction {\n    undo() {\n        this.editor.removeNode(this.node);\n    }\n    redo() {\n        this.editor.addNode(this.node);\n    }\n}\n\nexport class RemoveNodeAction extends NodeAction {\n    undo() {\n        this.editor.addNode(this.node);\n    }\n    redo() {\n        this.editor.removeNode(this.node);\n    }\n}\n\nexport class DragNodeAction extends NodeAction {\n    constructor(editor, node, prev) {\n        super(editor, node);\n\n        this.prev = [...prev];\n        this.new = [...node.position];\n    }\n\n    _translate(position) {\n        this.editor.view.nodes.get(this.node).translate(...position);\n    }\n    \n    undo() {\n        this._translate(this.prev);\n    }\n    redo() {\n        this._translate(this.new);\n    }\n    update(node) {\n        this.new = [...node.position];\n    }\n}","import Action from '../action';\n\nfunction reassign(connection) {\n    const { input, output } = connection;\n\n    return output.connections.find(c => c.input === input);\n}\n\nexport class AddConnectionAction extends Action {\n    constructor(editor, connection) {\n        super();\n        this.editor = editor;\n        this.connection = connection;\n    }\n    undo() {\n        this.editor.removeConnection(this.connection);\n    }\n    redo() {\n        this.editor.connect(this.connection.output, this.connection.input);\n        this.connection = reassign(this.connection);\n    }\n}\n\nexport class RemoveConnectionAction extends Action {\n    constructor(editor, connection) {\n        super();\n        this.editor = editor;\n        this.connection = connection;\n    }\n    undo() {\n        this.editor.connect(this.connection.output, this.connection.input);\n        this.connection = reassign(this.connection);\n    }\n    redo() {\n        this.editor.removeConnection(this.connection);\n    }\n}\n","import History from './history';\nimport Act from './action';\nimport { AddNodeAction, DragNodeAction, RemoveNodeAction } from './actions/node';\nimport { AddConnectionAction, RemoveConnectionAction } from './actions/connection';\n\nfunction trackNodes(editor, history) {\n    editor.on('nodecreated', node => history.add(new AddNodeAction(editor, node)));\n    editor.on('noderemoved', node => history.add(new RemoveNodeAction(editor, node)));\n    editor.on('nodetranslated', ({ node, prev }) => {\n        if (history.last instanceof DragNodeAction && history.last.node === node)\n            history.last.update(node);\n        else\n            history.add(new DragNodeAction(editor, node, prev));\n    });\n}\n\nfunction trackConnections(editor, history) {\n    editor.on('connectioncreated', c => history.add(new AddConnectionAction(editor, c)));\n    editor.on('connectionremoved', c => history.add(new RemoveConnectionAction(editor, c)));\n}\n\nfunction install(editor, { keyboard = true }) {\n    editor.bind('undo');\n    editor.bind('redo');\n    editor.bind('addhistory');\n\n    const history = new History();\n\n    editor.on('undo', () => history.undo());\n    editor.on('redo', () => history.redo());\n    editor.on('addhistory', action => history.add(action));\n\n    if (keyboard) document.addEventListener('keydown', e => {\n        if (!e.ctrlKey) return;\n\n        switch (e.code) {\n        case 'KeyZ': editor.trigger('undo'); break;\n        case 'KeyY': editor.trigger('redo'); break;\n        default:\n        }\n    });\n\n    trackNodes(editor, history);\n    trackConnections(editor, history);\n}\n\nexport const Action = Act;\n\nexport default {\n    name: 'history',\n    install\n}"],"names":["History","active","produced","reserved","action","push","from","to","type","pop","_do","length","Action","NodeAction","editor","node","AddNodeAction","removeNode","addNode","RemoveNodeAction","DragNodeAction","prev","new","position","view","nodes","get","translate","_translate","reassign","connection","input","output","connections","find","c","AddConnectionAction","removeConnection","connect","RemoveConnectionAction","trackNodes","history","on","add","last","update","trackConnections","install","keyboard","bind","undo","redo","document","addEventListener","e","ctrlKey","code","trigger","Act","name"],"mappings":"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"}